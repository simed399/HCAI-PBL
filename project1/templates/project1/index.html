{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Supervised Learning Interface</title>
  <link rel="stylesheet" href="{% static 'project1/style.css' %}">
</head>
<body>
  <header class="header">
    <h1>ðŸ“Š Supervised Learning Interface</h1>
    <p>Upload your data, explore it, and train modelsâ€”all in one place.</p>
  </header>

  <main class="container">
    {% if error %}
      <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    <!-- Upload Card -->
    <section class="card">
      <h2>1. Upload CSV</h2>
      <form method="post" enctype="multipart/form-data" class="form-inline">
        {% csrf_token %}
        <input class="file-input" type="file" name="csv_file" accept=".csv" required>
        <button class="btn" type="submit">Upload</button>
      </form>
    </section>

    {% if table %}
      <!-- Preview Card -->
      <section class="card">
        <h2>2. Data Preview</h2>
        <div class="table-wrapper">{{ table|safe }}</div>
      </section>

      <!-- Plot Card -->
      <section class="card">
        <h2>3. Scatter Plot</h2>
        <form method="post" class="form-grid">
          {% csrf_token %}
          <input type="hidden" name="action" value="plot">
          <div>
            <label for="feature_x">X:</label>
            <select id="feature_x" name="feature_x">{% for c in column_names %}<option>{{c}}</option>{% endfor %}</select>
          </div>
          <div>
            <label for="feature_y">Y:</label>
            <select id="feature_y" name="feature_y">{% for c in column_names %}<option>{{c}}</option>{% endfor %}</select>
          </div>
          <div>
            <label for="target">Color:</label>
            <select id="target" name="target">{% for c in column_names %}<option>{{c}}</option>{% endfor %}</select>
          </div>
          <div class="form-actions">
            <button class="btn" type="submit">Plot</button>
          </div>
        </form>
        {% if plot_url %}
          <div class="img-wrapper">
            <img src="data:image/png;base64,{{ plot_url }}" alt="scatter plot">
          </div>
        {% endif %}
      </section>

      <!-- Train Card -->
      <section class="card">
        <h2>4. Train a Model</h2>
        <form method="post" class="form-grid">
          {% csrf_token %}
          <input type="hidden" name="action" value="train">

          <div>
            <label for="problem-type">Problem:</label>
            <select id="problem-type" name="problem_type">
              <option value="classification">Classification</option>
              <option value="regression">Regression</option>
            </select>
          </div>

          <div class="target-group cls">
            <label for="tgt_cls">Target (cat):</label>
            <select id="tgt_cls" name="target_class">
              {% for c in column_names %}
                {% if c not in numeric_columns %}
                  <option>{{c}}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <div class="target-group reg">
            <label for="tgt_reg">Target (num):</label>
            <select id="tgt_reg" name="target_reg">
              {% for c in numeric_columns %}
                <option>{{c}}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="model-select">Model:</label>
            <select id="model-select" name="model">
              <option>LogisticRegression</option>
              <option>RandomForestClassifier</option>
              <option>LinearRegression</option>
              <option>RandomForestRegressor</option>
            </select>
          </div>

          <div>
            <label for="test-size">Test Size:</label>
            <input id="test-size" type="number" name="test_size" step="0.1" value="0.3">
          </div>

          <div class="param-group param-LogisticRegression">
            <label for="hp-c">C:</label>
            <input id="hp-c" type="number" name="hyperparam" step="0.1" value="1.0">
          </div>

          <div class="param-group param-RandomForestClassifier param-RandomForestRegressor">
            <label for="hp-n">n_estimators:</label>
            <input id="hp-n" type="number" name="hyperparam" step="1" value="100">
          </div>

          <div class="form-actions">
            <button class="btn" type="submit">Train</button>
          </div>
        </form>
      </section>

      {% if train_results %}
        <!-- Results Card -->
        <section class="card">
          <h2>5. Results</h2>
          {% if request.POST.problem_type == "classification" %}
            <p><strong>Accuracy:</strong> {{ train_results.accuracy }}  
            <strong>F1 Score:</strong> {{ train_results.f1_score }}</p>
            <div class="img-wrapper">
              <img src="data:image/png;base64,{{ train_results.confusion_matrix }}" alt="confusion matrix">
            </div>
          {% else %}
            <p><strong>MSE:</strong> {{ train_results.mse }}  
            <strong>RÂ²:</strong> {{ train_results.r2 }}</p>
            <div class="img-wrapper">
              <img src="data:image/png;base64,{{ train_results.reg_plot }}" alt="regression plot">
            </div>
          {% endif %}
        </section>
      {% endif %}
    {% endif %}
  </main>

  <script>
    // Toggle target selects
    const p = document.getElementById("problem-type"),
          cls = document.querySelectorAll(".cls"),
          reg = document.querySelectorAll(".reg"),
          mdl = document.getElementById("model-select"),
          pgs = document.querySelectorAll(".param-group");

    function updProblem(){
      cls.forEach(d => d.style.display = p.value==="classification" ? "block":"none");
      reg.forEach(d => d.style.display = p.value==="regression"     ? "block":"none");
    }
    p.addEventListener("change", updProblem);
    updProblem();

    function updParams(){
      pgs.forEach(pg => {
        pg.style.display = pg.classList.contains(`param-${mdl.value}`) 
          ? "block" : "none";
      });
    }
    mdl.addEventListener("change", updParams);
    updParams();
  </script>
</body>
</html>
