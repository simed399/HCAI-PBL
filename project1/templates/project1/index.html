{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Project 1: Supervised Learning Interface</title>
  <link rel="stylesheet" href="{% static 'home/style.css' %}">
  <style>
    /* hide both target‐groups and param‐groups by default */
    .target-group, .param-group { display: none; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="box">
    <div class="title-container">
      <div class="title">Project 1: Supervised Learning Interface</div>
    </div>
    <div class="main-text">

      <!-- 1️⃣ CSV Upload -->
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="file" name="csv_file" accept=".csv" required>
        <button type="submit">Upload CSV</button>
      </form>
      {% if error %}
        <p style="color:red;">Error: {{ error }}</p>
      {% endif %}

      <!-- 2️⃣ Data Preview -->
      {% if table %}
        <h3>Data Preview</h3>
        {{ table|safe }}
      {% endif %}

      <!-- 3️⃣ Scatter Plot -->
      {% if column_names %}
        <h3>Select Features to Plot</h3>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="plot">

          <label>X:</label>
          <select name="feature_x">
            {% for col in column_names %}
              <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
          </select>

          <label>Y:</label>
          <select name="feature_y">
            {% for col in column_names %}
              <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
          </select>

          <label>Color (target):</label>
          <select name="target">
            {% for col in column_names %}
              <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
          </select>

          <button type="submit">Plot</button>
        </form>
      {% endif %}

      {% if plot_url %}
        <h3>Scatter Plot</h3>
        <img src="data:image/png;base64,{{ plot_url }}" alt="scatter plot">
      {% endif %}

      <!-- 4️⃣ Train a Model -->
      {% if column_names %}
        <h3>Train a Model</h3>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="train">

          <label>Problem type:</label>
          <select id="problem-type" name="problem_type">
            <option value="classification">Classification</option>
            <option value="regression">Regression</option>
          </select>

          <!-- classification target -->
          <div class="target-group target-classification">
            <label>Target column:</label>
            <select name="target_col">
              {% for col in column_names %}
                <option value="{{ col }}">{{ col }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- regression target -->
          <div class="target-group target-regression">
            <label>Target column:</label>
            <select name="target_col">
              {% for col in numeric_columns %}
                <option value="{{ col }}">{{ col }}</option>
              {% endfor %}
            </select>
          </div>

          <label>Model:</label>
          <select id="model-select" name="model">
            <option value="LogisticRegression">Logistic Regression</option>
            <option value="RandomForestClassifier">Random Forest Classifier</option>
            <option value="LinearRegression">Linear Regression</option>
            <option value="RandomForestRegressor">Random Forest Regressor</option>
          </select>

          <label>Test size (0–1):</label>
          <input type="number" name="test_size" min="0.1" max="0.9" step="0.1" value="0.3">

          <!-- C for LogisticRegression -->
          <div class="param-group param-LogisticRegression">
            <label>C (inverse reg):</label>
            <input type="number" name="hyperparam" step="0.1" value="1.0">
          </div>
          <!-- n_estimators for both RandomForest models -->
          <div class="param-group param-RandomForestClassifier param-RandomForestRegressor">
            <label>n_estimators (trees):</label>
            <input type="number" name="hyperparam" step="1" value="100">
          </div>
          <!-- (no hyperparam for LinearRegression) -->

          <button type="submit">Train</button>
        </form>
      {% endif %}

      <!-- 5️⃣ Show Training Results -->
      {% if train_results %}
        <h3>Results</h3>
        {% if request.POST.problem_type == "classification" %}
          <p>Accuracy: {{ train_results.accuracy }}<br>
             F1 Score:  {{ train_results.f1_score }}</p>
          <h4>Confusion Matrix</h4>
          <img src="data:image/png;base64,{{ train_results.confusion_matrix }}" alt="confusion matrix">
        {% else %}
          <p>Mean Squared Error: {{ train_results.mse }}<br>
             R² Score:           {{ train_results.r2 }}</p>
        {% endif %}
      {% endif %}

    </div>
  </div>

  <!-- ─── JavaScript to toggle fields ───────────────────────────────────── -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const problemSelect = document.getElementById("problem-type");
      const classTargetDiv = document.querySelector(".target-classification");
      const regTargetDiv   = document.querySelector(".target-regression");
      const modelSelect    = document.getElementById("model-select");
      const paramGroups    = document.querySelectorAll(".param-group");

      function updateProblemFields() {
        if (problemSelect.value === "classification") {
          classTargetDiv.style.display = "block";
          regTargetDiv.style.display   = "none";
        } else {
          classTargetDiv.style.display = "none";
          regTargetDiv.style.display   = "block";
        }
      }
      problemSelect.addEventListener("change", updateProblemFields);
      updateProblemFields();

      function updateParamFields() {
        const m = modelSelect.value;
        paramGroups.forEach(pg => {
          pg.style.display = pg.classList.contains(`param-${m}`)
            ? "block"
            : "none";
        });
      }
      modelSelect.addEventListener("change", updateParamFields);
      updateParamFields();
    });
  </script>
</body>
</html>
